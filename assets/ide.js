phlo.exist=[]
phlo.existing=new WeakMap
const onExist=(els,cb)=>phlo.exist.push({els,cb})
app.updates.push(()=>{const existing=[];phlo.exist.forEach(item=>objects(item.els).forEach(el=>phlo.existing.has(el)||existing.push({el,cb:item.cb})));existing.forEach(item=>[phlo.existing.has(item.el)||phlo.existing.set(item.el,'exist'),item.cb(item.el)])})

function curLine(){const main=obj('main'),m=main.getBoundingClientRect(),cy=m.top+m.height/2;let best=null,bestDist=Infinity;for(const li of obj('ol.code').children){const r=li.getBoundingClientRect();if(r.bottom<m.top||r.top>m.bottom)continue;let d=0;if(cy<r.top)d=r.top-cy;else if(cy>r.bottom)d=cy-r.bottom;if(d<bestDist){bestDist=d;best=li;if(d===0)break}}return best?+best.id.slice(1):1}
function liNodes(root){return[...root.querySelectorAll('li')]}
function liIndexOf(root,li){const L=liNodes(root);for(let i=0;i<L.length;i++)if(L[i]===li)return i;return-1}
function textLen(node){let t=0,tw=document.createTreeWalker(node,NodeFilter.SHOW_TEXT);for(let n;n=tw.nextNode();)t+=n.data.length;return t}
function caretColIn(node,ctr,ofs){const r=document.createRange();r.selectNodeContents(node);try{r.setEnd(ctr,ofs)}catch{}return r.toString().length}
function getSelectionLC(root){const sel=getSelection();if(!sel||!sel.rangeCount)return{has:false};const r=sel.getRangeAt(0),se=(r.startContainer.nodeType===1?r.startContainer:r.startContainer.parentElement).closest('li'),ee=(r.endContainer.nodeType===1?r.endContainer:r.endContainer.parentElement).closest('li');if(!se||!ee)return{has:false};const sLine=liIndexOf(root,se),eLine=liIndexOf(root,ee),sCol=caretColIn(se,r.startContainer,r.startOffset),eCol=caretColIn(ee,r.endContainer,r.endOffset);return{has:true,start:{line:sLine,col:sCol},end:{line:eLine,col:eCol},collapsed:sel.isCollapsed}}
function nodeForOffsetInLi(li,col){const tw=document.createTreeWalker(li,NodeFilter.SHOW_TEXT);let n,rem=col;while(n=tw.nextNode()){if(rem<=n.data.length)return{node:n,offset:rem};rem-=n.data.length}return{node:li,offset:li.childNodes.length}}
function setSelectionFromLC(root,start,end){const L=liNodes(root);const sL=Math.min(Math.max(0,start.line),Math.max(0,L.length-1));const eL=Math.min(Math.max(0,end.line),Math.max(0,L.length-1));const sLI=L[sL],eLI=L[eL];const sCol=Math.min(start.col,textLen(sLI)),eCol=Math.min(end.col,textLen(eLI));const sPos=nodeForOffsetInLi(sLI,sCol),ePos=nodeForOffsetInLi(eLI,eCol);const sel=getSelection(),r=document.createRange();r.setStart(sPos.node,sPos.offset);r.setEnd(ePos.node,ePos.offset);sel.removeAllRanges();sel.addRange(r)}
function renderHighlighted(src){return highlight_Phlo(src).split('\n').map((l,i)=>`<li id="l${i+1}">${l||''}</li>`).join('')}
function highlightLine(l){const one=highlight_Phlo(l),nl=one.indexOf('\n');return nl===-1?one:one.slice(0,nl)}
function lineLengths(){const ed=obj('ol.code');const list=ed?[...ed.querySelectorAll('li')]:[];return list.map(li=>li.textContent.length)}
function indexFromLC(line,col){const lens=lineLengths(),n=lens.length;if(n===0)return 0;let l=Math.max(0,Math.min(line,n-1)),c=Math.max(0,Math.min(col,lens[l])),sum=0;for(let i=0;i<l;i++)sum+=lens[i]+1;return sum+c}
function lcFromIndex(idx){const lens=lineLengths();if(lens.length===0)return{line:0,col:0};let i=0,sum=0;while(i<lens.length){const end=sum+lens[i];if(idx<=end)return{line:i,col:Math.max(0,Math.min(idx-sum,lens[i]))};sum=end+1;i++}return{line:lens.length-1,col:lens[lens.length-1]}}
function caretIndex(){const ed=obj('ol.code');if(!ed)return 0;const sel=getSelectionLC(ed);if(sel.has){const p=sel.collapsed?sel.start:sel.end;return indexFromLC(p.line,p.col)}const ln=curLine();return indexFromLC(Math.max(0,ln-1),0)}
function syncCaretCache(){lastCaret=caretIndex()}
function getUndo(f){if(!f)return null;if(!undos.has(f))undos.set(f,{stack:[],index:-1,applying:false,lastGroup:null,max:200});return undos.get(f)}
function captureState(){const ed=obj('ol.code'),m=getSelectionLC(ed),text=contents();return{text,start:m.start||{line:0,col:0},end:m.has?m.end:(m.start||{line:0,col:0})}}
function restoreState(state){const ed=obj('ol.code');const f=activeFile();const U=getUndo(f);if(!U)return;U.applying=true;ed.innerHTML=renderHighlighted(state.text);ed.dataset.src=state.text;setSelectionFromLC(ed,state.start,state.end);ed.focus({preventScroll:true});app.update();U.applying=false;const s=sources.get(f)||{orig:state.text,curr:state.text,dirty:false};s.curr=state.text;s.dirty=s.curr!==s.orig;sources.set(f,s);syncCaretCache();updateDirtyUI()}
function updateDirtyUI(){const f=activeFile();if(!f)return;const s=sources.get(f);const dirty=!!(s&&s.curr!==s.orig);app.mod.class('#files .active',(dirty?'':'-')+'changed')}
function pushSnapshot(group='explicit'){const f=activeFile(),U=getUndo(f);if(!U||U.applying)return;const s=captureState(),top=U.stack[U.index];if(top&&top.text===s.text&&top.start.line===s.start.line&&top.start.col===s.start.col&&top.end.line===s.end.line&&top.end.col===s.end.col)return;if(U.index<U.stack.length-1)U.stack.splice(U.index+1);const now=Date.now(),merge=U.lastGroup&&U.lastGroup.name===group&&(now-U.lastGroup.at)<400;if(merge&&U.index>=0){U.stack[U.index]=s;U.lastGroup.at=now}else{U.stack.push(s);U.index++;U.lastGroup={name:group,at:now};if(U.stack.length>U.max){U.stack.shift();U.index--}}}
function doUndo(){const U=getUndo(activeFile());if(!U||U.index<=0)return;U.index--;restoreState(U.stack[U.index])}
function doRedo(){const U=getUndo(activeFile());if(!U||U.index>=U.stack.length-1)return;U.index++;restoreState(U.stack[U.index])}
function rehighlightChanged(editor){const U=getUndo(activeFile());if(U?.applying)return;const before=(editor.dataset.src??'').split('\n');const nodes=[...editor.querySelectorAll('li')];const now=nodes.map(li=>li.textContent);const nowStr=now.join('\n');const f=activeFile();const src=f?sources.get(f):null;const orig=src?.orig??nowStr;const unchanged=(orig===nowStr);app.mod.class('#files .active',(unchanged?'-':'')+'changed');const mark=getSelectionLC(editor);const differentCount=before.length!==now.length;if(differentCount){editor.innerHTML=now.map((l,i)=>`<li id="l${i+1}">${highlightLine(l)||''}</li>`).join('')}else{for(let i=0;i<now.length;i++)if(before[i]!==now[i])nodes[i].innerHTML=highlightLine(now[i])||''}if(mark.has)setSelectionFromLC(editor,mark.start,mark.end);if(f){const s=src||{orig:nowStr,curr:nowStr,dirty:false};s.curr=nowStr;s.dirty=s.curr!==s.orig;sources.set(f,s)}editor.dataset.src=nowStr;lastInputType='';syncCaretCache()}
function updateVisibleNodes(){const main=obj('main');if(!main)return;const m=main.getBoundingClientRect();const lis=[...obj('ol.code').children];let first=-1,last=-1;for(let i=0;i<lis.length;i++){const r=lis[i].getBoundingClientRect();if(r.bottom>=m.top&&r.top<=m.bottom){if(first===-1)first=i;last=i}}const nodes=[...obj('#nodes').querySelectorAll('div[data-line]')];for(const n of nodes){const L=(parseInt(n.dataset.line,10)||1)-1;(first!==-1&&L>=first&&L<=last)?n.classList.add('visible'):n.classList.remove('visible')}}
app.mod.caret=index=>{const ed=obj('ol.code');if(!ed)return;const pos=lcFromIndex(Math.max(0,parseInt(index,10)||0));setSelectionFromLC(ed,pos,pos);const li=ed.querySelectorAll('li')[pos.line];if(li)li.scrollIntoView({block:'center'});ed.focus({preventScroll:true});const f=activeFile(),U=getUndo(f);if(U){const snap=captureState();if(U.stack.length===0){U.stack.push(snap);U.index=0}else if(U.index===0&&U.stack[0].text===contents()){U.stack[0]=snap}}syncCaretCache()}
const contents=()=>[...obj('ol.code').querySelectorAll('li')].map(li=>li.textContent).join('\n')
const activeFile=()=>obj('#files .file.active')?.dataset.file
const sources=new Map()
const undos=new Map()
let composing=false,raf=0,lastInputType='',lastCaret=0,visRAF=0

const hint=(()=>{const BADGE={function:'ƒ',staticMethod:'::',staticProp:'::$',instanceMethod:'->',instanceProp:'->$',const:'const',class:'class',view:'view',readonly:'ro'};let index=[],catalog=null,open=false,node=null,sel={i:0,list:[]},ed=null,sig=null,savedSelLC=null
function hasText(x){return x!==undefined&&x!==null&&String(x).trim().length>0}
function manualHref(file,line){if(!file)return'';return `/phlo/${file}${line?`#l${line}`:''}`}
function mapGetInsensitive(mp,key){if(!mp)return null;if(mp.has(key))return mp.get(key);const low=String(key).toLowerCase();for(const[ k,v]of mp.entries())if(String(k).toLowerCase()===low)return v;return null}
function getClassInsensitive(name){if(!catalog||!catalog.classes)return null;if(catalog.classes.has(name))return catalog.classes.get(name);const low=String(name).toLowerCase();for(const[k,C]of catalog.classes.entries())if(String(k).toLowerCase()===low)return C;return null}
function getFuncInsensitive(name){if(!catalog||!catalog.functions)return null;if(catalog.functions.has(name))return catalog.functions.get(name);const low=String(name).toLowerCase();for(const[k,f]of catalog.functions.entries())if(String(k).toLowerCase()===low)return f;return null}
function init(editor){ed=editor;node=document.getElementById('phlo-hints')||Object.assign(document.body.appendChild(document.createElement('div')),{id:'phlo-hints',style:'position:absolute;z-index:9999;min-width:260px;max-width:560px;max-height:300px;overflow:auto;background:#111;border:1px solid #fff;border-radius:10px;box-shadow:0 8px 24px #0008;font-family:sans-serif;display:none'});node.onmousedown=e=>{e.preventDefault();e.stopPropagation()};node.ontouchstart=e=>{e.preventDefault();e.stopPropagation()};sig=document.getElementById('phlo-signature')||Object.assign(document.body.appendChild(document.createElement('div')),{id:'phlo-signature',style:'position:absolute;z-index:10000;max-width:60ch;background:#111;border:1px solid #fff;border-radius:10px;box-shadow:0 8px 24px #0008;padding:.25rem .5rem;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.85em;display:none;opacity:.95'});addEventListener('resize',()=>{reposition()})}
function loadIndex(raw){const classes=new Map(),F=new Map();for(const[name,meta]of Object.entries(raw.functions||{})){F.set(name,{name,args:meta.args??'',file:meta.file??'',line:meta.line??null,ret:meta.return??'mixed'})}for(const[cls,obj]of Object.entries(raw.objects||{})){const C={name:cls,file:obj.file??'',ctor:obj.args??'',consts:new Map(),staticMethods:new Map(),staticProps:new Map(),methods:new Map(),props:new Map()};const inst=obj['->']||{};for(const[n,m]of Object.entries(inst)){const t=m.type||'',a=m.args??'',line=m.line??null,ret=m.return??'mixed';if(t==='prop'||t==='readonly'||(t==='view'&&!a))C.props.set(n,{name:n,args:a,line,ret});else if(t==='view'||t==='method')C.methods.set(n,{name:n,args:a,line,ret});else C.props.set(n,{name:n,args:a,line,ret})}const stat=obj['::']||{};for(const[n,m]of Object.entries(stat)){const line=m.line??null;if(n.startsWith('$'))C.staticProps.set(n.slice(1),{name:n.slice(1),line});else if((m.type||'')==='const')C.consts.set(n,{name:n,line});else C.staticMethods.set(n,{name:n,args:m.args??'',line,ret:m.return??'mixed'})}classes.set(cls,C)}catalog={functions:F,classes};const out=[];for(const[name,meta]of F.entries()){out.push({label:name,owner:null,kind:'function',args:meta.args,insertText:name,sortKey:name.toLowerCase(),file:meta.file||'',line:meta.line??null})}for(const[cls,C]of classes.entries()){out.push({label:cls,owner:cls,kind:'class',args:C.ctor,insertText:cls,sortKey:cls.toLowerCase(),file:C.file||'',line:null});for(const[n,meta]of C.consts)out.push({label:n,owner:cls,kind:'const',args:'',insertText:n,sortKey:`${cls}::${n}`.toLowerCase(),file:C.file||'',line:meta.line??null});for(const[n,m]of C.staticMethods)out.push({label:n,owner:cls,kind:'staticMethod',args:m.args,insertText:n,sortKey:`${cls}::${n}`.toLowerCase(),file:C.file||'',line:m.line??null});for(const[n,p]of C.staticProps)out.push({label:n,owner:cls,kind:'staticProp',args:'',insertText:`$${n}`,sortKey:`${cls}::$${n}`.toLowerCase(),file:C.file||'',line:p.line??null});for(const[n,p]of C.props)out.push({label:n,owner:cls,kind:'instanceProp',args:p.args,insertText:n,sortKey:`${cls}->${n}`.toLowerCase(),file:C.file||'',line:p.line??null});for(const[n,m]of C.methods)out.push({label:n,owner:cls,kind:'instanceMethod',args:m.args,insertText:n,sortKey:`${cls}->${n}`.toLowerCase(),file:C.file||'',line:m.line??null})}index=out}
function currentCaretRect(){const sel=window.getSelection();if(!sel||!sel.rangeCount)return null;const r=sel.getRangeAt(0).cloneRange();r.collapse(false);const rects=r.getClientRects();if(rects.length)return rects[0];const pos=lcFromIndex(caretIndex());const li=obj('ol.code').children[pos.line];return li?li.getBoundingClientRect():null}
function highlightPrefix(label,pref){if(!pref)return label;try{const re=new RegExp(pref.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');return label.replace(re,m=>`<span class="hl" style="text-decoration:underline dotted">${m}</span>`)}catch{return label}}
function findOpenParenForward(left){let q=null,esc=false,depth=0;const stack=[];for(let i=0;i<left.length;i++){const ch=left[i];if(esc){esc=false;continue}if(ch==='\\'){esc=true;continue}if(q){if(ch===q)q=null;continue}if(ch==="'"||ch==='"'){q=ch;continue}if(ch==='('){stack.push(i);depth++;continue}if(ch===')'&&depth>0){stack.pop();depth--;continue}}if(!stack.length)return null;const pos=stack[stack.length-1];return{pos,inner:left.slice(pos+1)}}
function readIdentBackward(s,i){let j=i;while(j>=0&&/[A-Za-z0-9_]/.test(s[j]))j--;const name=s.slice(j+1,i+1);return{name,start:j+1,end:i}}
function findInstanceOwner(left){const arrow=left.lastIndexOf('->');if(arrow<0)return null;let i=arrow-1;while(i>=0&&/\s/.test(left[i]))i--;if(left[i]===')'){let depth=1,q=null,esc=false;i--;while(i>=0&&depth>0){const ch=left[i];if(esc){esc=false;i--;continue}if(ch==='\\'){esc=true;i--;continue}if(q){if(ch===q)q=null;i--;continue}if(ch==="'"||ch==='"'){q=ch;i--;continue}if(ch===')'){depth++;i--;continue}if(ch==='('){depth--;i--;continue}i--}while(i>=0&&/\s/.test(left[i]))i--}const end=i;const{name,start}=readIdentBackward(left,end);if(!/^[A-Za-z_]\w*$/.test(name))return null;if(left[start-1]!=='%')return null;return name}
function findCallContext(left){const open=findOpenParenForward(left);if(!open)return null;let k=open.pos-1;while(k>=0&&/\s/.test(left[k]))k--;if(k<0)return null;const{name,start}=readIdentBackward(left,k);if(!/^[A-Za-z_]\w*$/.test(name))return null;if(left.slice(0,start).endsWith('::')){const rest=left.slice(0,start-2);const clsId=readIdentBackward(rest,rest.length-1);if(!/^[A-Za-z_]\w*$/.test(clsId.name))return null;const C=getClassInsensitive(clsId.name);if(!C)return null;const m=mapGetInsensitive(C.staticMethods,name);if(m)return{kind:'staticMethod',owner:C.name,name,argsSoFar:open.inner};return null}if(left.slice(0,start).endsWith('->')){const ownerName=findInstanceOwner(left.slice(0,start));const C=ownerName?getClassInsensitive(ownerName):null;if(!C)return null;const m=mapGetInsensitive(C.methods,name);if(m)return{kind:'instanceMethod',owner:C.name,name,argsSoFar:open.inner};const p=mapGetInsensitive(C.props,name);if(p&&hasText(p.args))return{kind:'instanceProp',owner:C.name,name,argsSoFar:open.inner};return null}if(left[start-1]==='%'){const C=getClassInsensitive(name);if(C)return{kind:'ctor',owner:C.name,name:'__construct',argsSoFar:open.inner}}const f=getFuncInsensitive(name);if(f)return{kind:'function',owner:null,name,argsSoFar:open.inner};return null}
function isInsideString(left){let q=null,esc=false;for(let i=0;i<left.length;i++){const ch=left[i];if(esc){esc=false;continue}if(ch==='\\'){esc=true;continue}if(!q&&(ch==="'"||ch=='"'))q=ch;else if(q&&ch===q)q=null}return !!q}
function getContext(){const full=contents(),idx=caretIndex(),left=full.slice(Math.max(0,idx-320),idx);const call=findCallContext(left);if(call)return{mode:'args',call,left};let m=left.match(/([A-Za-z_]\w*)::([A-Za-z_]*)$/);if(m){const C=getClassInsensitive(m[1]);if(C)return{mode:'static',owner:C.name,prefix:m[2]||'',left}}const mArrow=left.match(/->([A-Za-z_]*)$/);if(mArrow){const ownerName=findInstanceOwner(left);const C=ownerName?getClassInsensitive(ownerName):null;if(C)return{mode:'instance',owner:C.name,prefix:mArrow[1]||'',left}}const mObj=left.match(/%([A-Za-z_]*)$/);if(mObj)return{mode:'objectName',owner:null,prefix:mObj[1]||'',left};const mWord=left.match(/[A-Za-z_]\w*$/);const prefix=mWord?mWord[0]:'';return{mode:'generic',owner:null,prefix,left}}
function scoreItem(it,ctx){if(ctx.mode==='static'){if(it.owner!==ctx.owner)return-1;if(!['staticMethod','staticProp','const'].includes(it.kind))return-1}else if(ctx.mode==='instance'){if(it.owner!==ctx.owner)return-1;if(!['instanceMethod','instanceProp','view','readonly'].includes(it.kind))return-1}else if(ctx.mode==='objectName'){if(it.kind!=='class')return-1}else if(ctx.mode==='generic'){if(!['class','function'].includes(it.kind))return-1;if(ctx.prefix.length<2&&!/^[A-Z]/.test(ctx.prefix))return-1}const p=(ctx.prefix||'').toLowerCase(),lab=it.label.toLowerCase();if(!p)return 10;if(lab.startsWith(p))return 100-(lab.length-p.length);const i=lab.indexOf(p);if(i>=0)return 60-i;let pi=0,si=0;while(pi<p.length&&si<lab.length){if(lab[si]===p[pi])pi++;si++}return(pi===p.length)?30-(si-p.length):-1}
function buildList(ctx){const items=[];for(const it of index){const sc=scoreItem(it,ctx);if(sc<0)continue;items.push({it,sc})}items.sort((a,b)=>{if(b.sc!==a.sc)return b.sc-a.sc;const pr=k=>{if(ctx.mode==='static'){if(k==='staticMethod')return 4;if(k==='staticProp'||k==='const')return 3;return 1}if(ctx.mode==='instance'){if(k==='view')return 5;if(k==='instanceMethod')return 4;if(k==='instanceProp')return 3;if(k==='readonly')return 2;return 1}if(ctx.mode==='objectName'){if(k==='class')return 2;return 1}if(k==='class')return 3;if(k==='function')return 2;return 1};const ra=pr(a.it.kind),rb=pr(b.it.kind);if(rb!==ra)return rb-ra;return a.it.sortKey.localeCompare(b.it.sortKey)});return items.slice(0,12).map(x=>x.it)}
function position(){if(!open)return;const r=currentCaretRect();if(!r)return close();const pageX=r.left+window.scrollX,pageY=r.bottom+window.scrollY+6;node.style.left=Math.max(6,Math.min(pageX,window.innerWidth-node.offsetWidth-6))+'px';const below=pageY+node.offsetHeight<(window.scrollY+window.innerHeight-6);node.style.top=(below?pageY:(r.top+window.scrollY-node.offsetHeight-6))+'px'}
function openWith(list,ctx){if(!list.length){return close()}savedSelLC=getSelectionLC(ed);sel={i:0,list};render(list,ctx);node.style.display='block';open=true;position()}
function close(){if(node){node.style.display='none';node.innerHTML=''}open=false;savedSelLC=null}
function select(i){const items=[...node.querySelectorAll('.item')];if(!items.length)return;sel.i=Math.max(0,Math.min(i,items.length-1));items.forEach(it=>it.classList.remove('active'));items[sel.i].classList.add('active')}
function render(list,ctx){if(!node)return;node.innerHTML=list.map((it,i)=>{const badge=BADGE[it.kind]||'';const meta=it.args?it.args:'';const href=manualHref(it.file||'',it.line??null);return `<div class="item${i===0?' active':''}" data-i="${i}" style="display:flex;align-items:baseline;gap:.5rem;padding:.25rem .5rem;cursor:pointer;white-space:nowrap;">
<span class="kind" style="display:inline-block;width:2.4em;text-align:right;opacity:.8;font-size:.85em;">${badge}</span>
<span class="label" style="font-weight:600">${highlightPrefix(it.label,ctx.prefix)}</span>
<span class="meta" style="margin-left:auto;opacity:.7;font-size:.8em;display:flex;align-items:baseline;gap:.5rem;">${meta?`<span>${meta}</span>`:''}${href?`<a class="doc" href="${href}" target="_ref" style="opacity:.8;text-decoration:underline dotted;">manual</a>`:''}</span>
</div>`}).join('');node.querySelectorAll('.item').forEach(div=>{div.onmouseenter=()=>select(+div.dataset.i);div.onclick=()=>accept()});node.querySelectorAll('a.doc').forEach(a=>{a.addEventListener('click',e=>{e.stopPropagation();e.stopImmediatePropagation()})})}
function positionSig(){if(!sig||sig.style.display==='none')return;const r=currentCaretRect();if(!r)return hideSig();const pageX=r.left+window.scrollX,pageY=r.bottom+window.scrollY+8;sig.style.left=Math.max(6,Math.min(pageX,window.innerWidth-sig.offsetWidth-6))+'px';const below=pageY+sig.offsetHeight<(window.scrollY+window.innerHeight-8);sig.style.top=(below?pageY:(r.top+window.scrollY-sig.offsetHeight-8))+'px'}
function showSig(text){sig.innerHTML=text;sig.style.display='block';positionSig()}
function hideSig(){sig.style.display='none'}
function currentParamIndex(inner){let depth=0,q=null,esc=false,idx=0;for(let i=0;i<inner.length;i++){const ch=inner[i];if(esc){esc=false;continue}if(ch==='\\'){esc=true;continue}if(q){if(ch===q)q=null;continue}if(ch==="'"||ch==='"'){q=ch;continue}if(ch==='('){depth++;continue}if(ch===')'&&depth>0){depth--;continue}if(ch===','&&depth===0)idx++}return idx}
function splitTopLevel(s){let out=[],buf='',q=null,esc=false,depth=0;for(let i=0;i<s.length;i++){const ch=s[i];if(esc){buf+=ch;esc=false;continue}if(ch==='\\'){buf+=ch;esc=true;continue}if(q){buf+=ch;if(ch===q)q=null;continue}if(ch==='"'||ch=="'"){buf+=ch;q=ch;continue}if(ch==='('){depth++;buf+=ch;continue}if(ch===')'){if(depth>0)depth--;buf+=ch;continue}if(ch===','&&depth===0){out.push(buf);buf='';continue}buf+=ch}out.push(buf);return out}
function parseParamsDef(def){if(!hasText(def))return[];return splitTopLevel(def).map(p=>{const t=p.trim(),v=/\.\.\.\s*\$([A-Za-z_]\w*)/i.exec(t),m=/\$([A-Za-z_]\w*)/i.exec(t);return{text:t,name:(v?v[1]:(m?m[1]:'')),variadic:!!v}})}
function parseCallState(inner){const parts=splitTopLevel(inner||''),idx=Math.max(0,parts.length-1),seg=(parts[idx]||'').trim(),nm=(/([A-Za-z_]\w*)\s*[:=]/.exec(seg)||[])[1]||null;return{index:idx,named:nm}}
function signatureFor(call){const def=(()=>{if(call.kind==='function'){const f=getFuncInsensitive(call.name);return{title:call.name,args:f?.args||'',ret:f?.ret||'mixed'}}if(call.kind==='staticMethod'){const C=getClassInsensitive(call.owner),m=C?mapGetInsensitive(C.staticMethods,call.name):null;return{title:`${C?C.name:call.owner}::${call.name}`,args:m?.args||'',ret:m?.ret||'mixed'}}if(call.kind==='instanceMethod'||call.kind==='view'){const C=getClassInsensitive(call.owner),m=C?mapGetInsensitive(C.methods,call.name):null;return{title:`${C?C.name:call.owner}->${call.name}`,args:m?.args||'',ret:m?.ret||'mixed'}}if(call.kind==='instanceProp'){const C=getClassInsensitive(call.owner),p=C?mapGetInsensitive(C.props,call.name):null;return{title:`${C?C.name:call.owner}->${call.name}`,args:p?.args||'',ret:p?.ret||'mixed'}}if(call.kind==='ctor'){const C=getClassInsensitive(call.owner);return{title:`%${C?C.name:call.owner}`,args:C?.ctor||'',ret:''}}return{title:'',args:'',ret:''}})(),params=parseParamsDef(def.args),st=parseCallState(call.argsSoFar||'');if(!params.length){if(call.kind==='instanceProp'&&!hasText(def.args))return `${def.title} → ${def.ret||'mixed'}`;return `${def.title}()${def.ret?` → ${def.ret}`:''}`}let hi=0;if(st.named){const w=st.named.toLowerCase(),j=params.findIndex(p=>p.name&&p.name.toLowerCase()===w);hi=j>=0?j:params.length-1}else{const i=st.index;if(i>=params.length){const last=params[params.length-1];hi=last&&last.variadic?params.length-1:Math.min(i,params.length-1)}else hi=i}const parts=params.map((p,i)=>i===hi?`<b style="text-decoration:underline dotted">${p.text}</b>`:p.text);if(call.kind==='instanceProp'){if(hasText(def.args))return `${def.title}(${parts.join(', ')}) → ${def.ret||'mixed'}`;return `${def.title} → ${def.ret||'mixed'}`}return `${def.title}(${parts.join(', ')})${def.ret?` → ${def.ret}`:''}`}
function replacePrefix(prefixLen,text){const idx=caretIndex();const begin=Math.max(0,idx-(prefixLen||0));const s=lcFromIndex(begin),e=lcFromIndex(idx);setSelectionFromLC(ed,s,e);document.execCommand('insertText',false,text)}
function metaForChoice(choice,ctx){const ownerName=(ctx&&ctx.owner)||choice.owner||null;if(choice.kind==='function'){const f=getFuncInsensitive(choice.label);return{args:f?.args||'',ret:f?.ret||'mixed',file:f?.file||'',line:f?.line||null}}if(choice.kind==='class'){const C=getClassInsensitive(ownerName||choice.label);return{args:C?.ctor||'',ret:'mixed',file:C?.file||'',line:null}}if(choice.kind==='staticMethod'){const C=getClassInsensitive(ownerName);const m=C?mapGetInsensitive(C.staticMethods,choice.label):null;return{args:m?.args||'',ret:m?.ret||'mixed',file:C?.file||'',line:m?.line||null}}if(choice.kind==='staticProp'){const C=getClassInsensitive(ownerName);const p=C?mapGetInsensitive(C.staticProps,choice.label):null;return{args:'',ret:'mixed',file:C?.file||'',line:p?.line||null}}if(choice.kind==='const'){const C=getClassInsensitive(ownerName);const k=C?mapGetInsensitive(C.consts,choice.label):null;return{args:'',ret:'mixed',file:C?.file||'',line:k?.line||null}}if(choice.kind==='instanceMethod'){const C=getClassInsensitive(ownerName);const m=C?mapGetInsensitive(C.methods,choice.label):null;return{args:m?.args||'',ret:m?.ret||'mixed',file:C?.file||'',line:m?.line||null}}if(choice.kind==='instanceProp'){const C=getClassInsensitive(ownerName);const p=C?mapGetInsensitive(C.props,choice.label):null;return{args:p?.args||'',ret:p?.ret||'mixed',file:C?.file||'',line:p?.line||null}}return{args:'',ret:'mixed',file:'',line:null}}
function accept(){if(!open||!sel.list.length)return false;const choice=sel.list[sel.i];const ctx=getContext();const meta=metaForChoice(choice,ctx);let insert=choice.insertText;const canHaveParens=(choice.kind==='function'||choice.kind==='staticMethod'||choice.kind==='instanceMethod'||choice.kind==='instanceProp');const hasArgs=hasText(meta.args);const shouldAddParens=canHaveParens&&hasArgs;const full=contents();const cidx=caretIndex();const nextChar=full[cidx]||'';if(shouldAddParens&&nextChar!=='(')insert+='()';let prefixLen=0;if(ctx&&typeof ctx.prefix==='string')prefixLen=ctx.prefix.length;pushSnapshot('completion');if(savedSelLC&&savedSelLC.start&&savedSelLC.end)setSelectionFromLC(ed,savedSelLC.start,savedSelLC.end);replacePrefix(prefixLen,insert);if(shouldAddParens&&nextChar!=='('){const after=caretIndex();setSelectionFromLC(ed,lcFromIndex(after-1),lcFromIndex(after-1))}close();hideSig();return true}
function onInput(editor){if(!editor||composing)return;const ctx=getContext();if(ctx.mode==='args'){const sigText=signatureFor(ctx.call);if(sigText){showSig(sigText)}else{hideSig()}close();positionSig();return}else hideSig();if(isInsideString(ctx.left)){close();return}const shouldOpen=(ctx.mode==='static'||ctx.mode==='instance'||ctx.mode==='objectName')||(ctx.mode==='generic'&&(ctx.prefix.length>=2||/^[A-Z]/.test(ctx.prefix)));if(!shouldOpen){close();return}const list=buildList(ctx);if(!list.length){close();return}openWith(list,ctx)}
function onKeydown(editor,e){if(open&&e.shiftKey&&(e.key==='Home'||e.key==='End'))return false;if(!open&&((e.key===' '&&e.ctrlKey)||(e.key==='/'&&e.altKey))){e.preventDefault();e.stopPropagation();on('input',editor);return true}if(!open)return false;if(['ArrowDown','ArrowUp','PageDown','PageUp'].includes(e.key)){e.preventDefault();e.stopPropagation();if(e.key==='ArrowDown')select(sel.i+1);if(e.key==='ArrowUp')select(sel.i-1);if(e.key==='PageDown')select(sel.i+5);if(e.key==='PageUp')select(sel.i-5);position();return true}if(e.key==='Home'||e.key==='End'){e.preventDefault();e.stopPropagation();if(e.key==='Home')select(0);else select(sel.list.length-1);position();return true}if(e.key==='Enter'||e.key==='Tab'){e.preventDefault();e.stopPropagation();accept();return true}if(e.key==='Escape'){e.preventDefault();e.stopPropagation();close();hideSig();return true}if([';','}',')',':'].includes(e.key)){close();return false}return false}
function reposition(){position();positionSig()}
return{init,loadIndex,onInput,onKeydown,close,open:()=>open,reposition}})()

on('compositionstart','ol.code',()=>composing=true)
on('compositionend','ol.code',el=>{composing=false;rehighlightChanged(el)})

on('input','ol.code',ed=>{if(composing)return;cancelAnimationFrame(raf);raf=requestAnimationFrame(()=>rehighlightChanged(ed))})
on('input','ol.code',ed=>{if(!composing)hint.onInput(ed)})
on('keydown','ol.code',(ed,e)=>{if(hint.onKeydown(ed,e))return})
on('keydown','ol.code',(ed,e)=>{if(e.key==='Tab'){e.preventDefault();if(!hint.open())document.execCommand('insertHTML',false,'&#009');return}if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();const file=activeFile();if(!file)return;const text=contents();const s=sources.get(file)||{orig:text,curr:text,dirty:false};s.orig=text;s.curr=text;s.dirty=false;sources.set(file,s);app.put(app.uri+'/save',{file,contents:text});pushSnapshot('save');updateDirtyUI();return}if(e.ctrlKey||e.metaKey){if(e.key.toLowerCase()==='z'&&!e.shiftKey){e.preventDefault();doUndo();return}if((e.key.toLowerCase()==='z'&&e.shiftKey)||e.key.toLowerCase()==='y'){e.preventDefault();doRedo();return}}})
on('beforeinput','ol.code',(ed,e)=>{lastInputType=e.inputType||'';const g=/insertText|deleteContentBackward|deleteContentForward|insertFromPaste|insertParagraph|insertLineBreak/.test(lastInputType)?'typing':lastInputType||'other';pushSnapshot(g)})
document.addEventListener('selectionchange',()=>{const ed=obj('ol.code'),sel=getSelection();if(ed&&sel&&sel.rangeCount&&ed.contains(sel.anchorNode))syncCaretCache()})

let listChanged=false
on('click','.box',box=>{const open=box.textContent==='+';box.textContent=open?'-':'+';obj('#files').classList.toggle('all',open);if(!open&&listChanged){listChanged=false;setTimeout(()=>app.put(app.uri+'/files',{open:Array.from(objects('#files div.open')).map(el=>el.dataset.file)}),500)}})
on('change','#nav',nav=>{if(nav.value)location.assign(nav.value)})

on('click','#files div.file',el=>{const next=el.dataset.file;if(obj('#files').classList.contains('all')){el.classList.toggle('open');listChanged=true;return}if(activeFile()===next)return;const caret=lastCaret;const cached=sources.get(next);if(cached){app.mod.class('#files .active','-active');app.mod.class(el,'active');const ed=obj('ol.code'),U=getUndo(next);U.applying=true;ed.dataset.src=cached.curr;ed.innerHTML=renderHighlighted(cached.curr);U.applying=false;app.update();app.get(app.uri+'/filemeta'+next+'@'+caret);return}app.get(app.uri+'/file'+next+'@'+caret)})

onExist('ol.code',ed=>{hint.init(ed);hint.loadIndex(window.PHLO_INDEX||{functions:{},objects:{}});let raw='';const lis=ed.querySelectorAll('li');if(lis.length)raw=[...lis].map(li=>li.textContent).join('\n');else raw=ed.textContent||'';ed.innerHTML=renderHighlighted(raw);ed.dataset.src=raw;const f=activeFile();if(f&&!sources.has(f))sources.set(f,{orig:raw,curr:raw,dirty:false});const caretAttr=obj('main[data-caret]')?.dataset.caret;if(caretAttr)app.mod.caret(caretAttr);else{const pos=lcFromIndex(0);setSelectionFromLC(ed,pos,pos)}syncCaretCache();updateVisibleNodes()})

on('click','#nodes div[data-line]',el=>{const ln=Math.max(1,parseInt(el.dataset.line,10)||1);const ed=obj('ol.code');if(!ed)return;const li=obj('#l'+ln),list=[...ed.querySelectorAll('li')];const i=Math.max(0,list.indexOf(li));const idx=indexFromLC(i,0);app.mod.caret(idx)})

on('keydown','#AI textarea',(el,e)=>e.ctrlKey&&e.key==='Enter'&&obj('form')?.requestSubmit())
on('submit','form',(el,e)=>{e.preventDefault();const q=obj('#AI textarea').value;if(!q.trim())return;app.post(app.uri+'/question',{question:q})})
on('click','body',(el,e)=>{const a=obj('#answer');if(a&&e.target!==a)app.mod.remove('#answer')})

addEventListener('beforeunload',e=>{for(const s of sources.values())if(s.dirty){e.preventDefault();e.returnValue='';break}})
const lc=obj('main[data-caret]');if(lc)app.mod.caret(lc.dataset.caret)
on('scroll','main',()=>{cancelAnimationFrame(visRAF);visRAF=requestAnimationFrame(()=>{updateVisibleNodes();hint.reposition()})})
addEventListener('resize',()=>{cancelAnimationFrame(visRAF);visRAF=requestAnimationFrame(()=>{updateVisibleNodes();hint.reposition()})})
